name: Build

on: [ pull_request, workflow_dispatch ]

permissions: read-all

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Xcode
        run: |
          sudo xcode-select -s "/Applications/Xcode_16.app"
          xcodebuild -version
      - name: Allow macro
        run: |
          defaults write com.apple.dt.Xcode IDESkipMacroFingerprintValidation -bool YES
      - name: Build
        uses: yukiarrr/ios-build-action@v1.12.0
        with:
          project-path: Chato.xcodeproj
          p12-base64: ${{ secrets.CERTIFICATES_P12 }}
          certificate-password: ${{secrets.CERTIFICATES_P12_PASSWORD}}
# https://www.andrewhoog.com/post/how-to-build-an-ios-app-with-github-actions-2023/
          mobileprovision-base64: ${{ secrets.MOBILEPROVISION }}
          code-signing-identity: ${{ secrets.CODE_SIGN_IDENTITY }}
          team-id: ${{ secrets.TEAM_ID }}
#          workspace-path: Unity-iPhone.xcworkspace # optional
#      - name: Build
#        run: xcodebuild -project "$XCODE_PROJECT" -scheme "$XCODE_SCHEME" archive CODE_SIGN_IDENTITY="$CODE_SIGN_IDENTITY" -archivePath "$BUILD_DIR/$XCODE_ARCHIVE"
#      - name: Export
#        run: |
#          plutil -convert xml1 - -o "$EXPORT_OPTIONS_PLIST" << EOF
#            {
#              "destination": "export",
#              "method": "mac-application"
#            }
#          EOF
#
#          xcodebuild -exportArchive -archivePath "$BUILD_DIR/$XCODE_ARCHIVE" -exportPath "$BUILD_DIR" -exportOptionsPlist "$EXPORT_OPTIONS_PLIST"
#      - name: Resign App
#        run: codesign --force --deep -s "$CODE_SIGN_IDENTITY" "$BUILD_DIR/$APP_NAME"
#      - name: Make DMG
#        run: hdiutil create -srcdir "$BUILD_DIR" -volname "$DMG_NAME" "$DMG_FILE_NAME"
#      - name: Upload
#        uses: actions/upload-artifact@v4
#        with:
#          name: Build
#          path: ${{ env.DMG_FILE_NAME }}
